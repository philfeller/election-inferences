# 1850s CT election inferences

## Getting started

This project has been tested using the Docker image that is defined in Dockerfile. That same image could also be used to create a container in which to execute the code for the elections project.
- Download and install [Docker Desktop](https://www.docker.com/products/docker-desktop/)
- docker pull ghcr.io/philfeller/election-inferences

If you do not use the Docker container, download and install [RStudio](https://posit.co/products/open-source/rstudio/), You will also need to install the R packages that are installed in the Docker image. The renv.lock file has all of the necessary packages and their dependencies, and it can be used to install them in another R instance. See the [renv package documentation](https://rstudio.github.io/renv/articles/renv.html) for more information on how to use this file.

## Installation

Download the project's source code, either by cloning this repo or by downloading a file that contains the source code. Note that the *.Rda files are stored using LFS; after executing the 'git clone' command, execute 'git lfs install && git lfs fetch --all && git lfs checkout'.

If you choose to use the Docker image:
- Create a container from the image.
- Use 'docker cp' to copy the source code to the container.

If you choose to use RStudio, set the directory with the source code as the working directory.

## Using the programs

A typical execution is done in three steps:
1. Create and download an extract from IPUMS US census data.
```
export API_KEY=your API key
Rscript download_ipums.R
```
2. Calculate inferences:
```
Rscript voter_regressions.R
```
3. Analyze the data generated by the previous step:
```
Rscript analyze_results.R
```
## Files included in project

### R
- lookup_1850.Rda - Defines the range of IPUMS serial numbers for a particular town in 1850
- lookup_1860.Rda - Defines the range of IPUMS serial numbers for a particular town in 1860
- missing_1860_ipums_rows.Rda - Data that is missing from IPUMS digitized transcription
- download_ipums.R - Download census data from IPUMS; requires an API key and that the key is defined in environment variable API_KEY.
- global.R - Loads pacakges and defines variables that are used elsewhere, including the paths for the files that were loadloaded from IPUMS.
- ct_demographics.R - Creates Tidyverse tibbles from the IPUMS data, summarizing by town and calculating information, such as GINI index.
- results_utils.R - Defines utility functions that are used by prepare_results.R and regression scripts
- prepare_results.R - Defines functions that take election results for a pair of years and prepare them for analysis
- betas.R - Defines functions to extract beta values from the MCMC data that is created by the eiPack inference.
- present.R - Defines functions for presenting betas in various formats
- inference_utils.R - Defines utility functions that are used by regression scripts
- voter_regressions.R - This is the script that calculate election inferences. It sources the scripts that need to have been run first.
- covariate_regression.R - Script that calculates election inferences using demographic and geographic covariates
- model_evaluation.R - Defines functions that evaluate the MCMC model fit
- create_sankey.R - Creates a sankey diagram from the election inferences; renders it into HTML
- sankey.Rda - A sample sankey diagram created by create_sankey.R
- ct_demographics.Rda - Calculated demographic factors by town
- census_utils.R - Defines utility functions that are used by analyze_results.R and ct_demographics.R
- results.Rda - Tibbles with election-pair results
- maps.Rda - Dynamically created maps of Connecticut towns for each of the regressions
- 1852_inference.Rda - Output from a typical execution of voter_regressions.R, estimating voter shifts between 1851 and 1852
- 1852_covariate_inference.Rda - Output from a typical execution of covariate_regression.R, estimating voter shifts between 1851 and 1852 using covariates
- 1853_inference.Rda - Output from a typical execution of voter_regressions.R, estimating voter shifts between 1852 and 1853
- 1853_covariate_inference.Rda - Output from a typical execution of covariate_regression.R, estimating voter shifts between 1852 and 1853
- 1854_inference.Rda - Output from a typical execution of voter_regressions.R, estimating voter shifts between 1853 and 1854
- 1854_covariate_inference.Rda - Output from a typical execution of covariate_regression.R, estimating voter shifts between 1853 and 1854
- 1855_inference.Rda - Output from a typical execution of voter_regressions.R, estimating voter shifts between 1854 and 1855
- 1855_covariate_inference.Rda - Output from a typical execution of covariate_regression.R, estimating voter shifts between 1854 and 1855
- 1856_inference.Rda - Output from a typical execution of voter_regressions.R, estimating voter shifts between 1855 and 1856
- 1856_covariate_inference.Rda - Output from a typical execution of covariate_regression.R, estimating voter shifts between 1855 and 1856
- 1857_inference.Rda - Output from a typical execution of voter_regressions.R, estimating voter shifts between 1856 and 1857
- 1857_covariate_inference.Rda - Output from a typical execution of covariate_regression.R, estimating voter shifts between 1856 and 1857
- 1851-1857_inference.Rda - Output from a typical execution of voter_regressions.R, estimating voter shifts between 1851 and 1857
- 1851-1857_covariate_inference.Rda - Output from a typical execution of covariate_regression.R, estimating voter shifts between 1851 and 1857
- analyze_results.R - Loads the inferences.Rda data file that was created by prepare_results.R and performs the statistical analysis that is used in the paper.
- test.R - Contains one simple inference and a few graphs; it is used by the CI/CD pipeline to test that all needed files are included and working as expected.

### Other census data
The Social Statistics schedule includes the number of religious accommodations (seats) by demonination; and schedule images are available on [FamilySearch](https://www.familysearch.org/records/images/search-results?page=1&place=346&endDate=1860&startDate=1860&creator=Federal%20Census). These data were hand-entered into a CSV file.
- 1860_CT_religious_accomodation.csv

### Elections data
These data were downloaded from [the Connecticut Secetary of State](https://electionhistory.ct.gov/eng/contests/search/year_from:1849/year_to:1857).
- electionhistory_ct_gov_eng_contests_search_year_from_1849_year_to_1857_stage_et_id_3_show_granularity_dt_id_1.csv.gz

### ESRI shapefiles
These files were created from a [Connecticut GIS file](https://ct-deep-gis-open-data-website-ctdeep.hub.arcgis.com/maps/82672ae5f3764021b9a4804f524f928b/about). Where towns were created from parts of other towns, I've drawn boundaries that conform as closely as possible to historic maps or town histories.
- 1855_CT_towns.shp
- 1855_CT_towns.shx
- 1855_CT_towns.dbf
- 1855_CT_towns.prj
- 1857_CT_towns.shp
- 1857_CT_towns.shx
- 1857_CT_towns.dbf
- 1857_CT_towns.prj
- 1850_railroads.cpg
- 1850_railroads.shp
- 1850_railroads.shx
- 1850_railroads.dbf
- 1850_railroads.prj

### Rmarkdown files
md/age_distribution.Rmd - Native-born male age distribution plots
md/index.Rmd - Main page for GitHub Pages site
md/model.Rmd - Description of multinomial-Dirichlet model and my implementation
md/office_correlation.Rmd - Correlation between voting for different offices
md/renda.Rmd - Comparison to Lex Renda's 1991 ecological regression
md/sankey.Rmd - Sankey diagram and transition tables for election inferences
md/uncertainty.Rmd - Uncertainty analysis of election inference for 1854-1855

### HTML files
html/age_distribution.html - Native-born male age distribution plots
html/index.html - Main page for GitHub Pages site
html/office_correlation.html - Correlation between voting for different offices
html/model.html - Description of multinomial-Dirichlet model and my implementation
html/renda.html - Comparison to Lex Renda's 1991 ecological regression
html/sankey.html - Sankey diagram and transition tables for election inferences
html/uncertainty.html - Uncertainty analysis of election inference for 1854-1855
html/age_distribution_files/figure-html/ - PNG chart images for age_distribution.html
html/uncertainty_files/figure-html/ - PNG plot images for uncertainty.html
html/site_libs/ - CSS and JavaScript files used by GitHub Pages site

### Docker files
- docker/Dockerfile - Docker file used to build the ghcr.io/philfeller/election-inferences image
- docker/renv.lock - File that defines the R packages to be installed in the image
- runner/Dockerfile - Docker file used to build a self-hosted runner image
- runner/entrypoint.sh - BASH script used within the image to register and start a self-hosted runner

### GitHub files
- .github/workflows/deploy-image.yml - Builds and deploys the main Docker image
- .github/workflows/deploy-runner-image.yml - Builds and deploys the Docker image used for runners
- .github/workflows/test-code.yml - Tests the integrity of the code on a self-hosted runner using the ghcr.io/philfeller/election-inferences image.
- .github/workflows/pages-deploy.yml - Deploys the GitHub Pages site
- .gitattributes - Defines the files that are stored using LFS
